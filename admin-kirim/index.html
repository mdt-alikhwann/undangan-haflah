<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard WhatsApp - Undangan Online</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<style>*{font-size:13px;box-sizing:border-box;}</style>
<body>

<div class="container py-5">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
    <h1 class="fw-bold text-success mb-0">
      <i class="bi bi-person-lines-fill me-1 h1"></i>Data Undangan
    </h1>
    <button class="btn btn-success shadow-sm" data-bs-toggle="modal" data-bs-target="#tambahModal">
      <i class="bi bi-plus-circle me-1"></i> Tambah Data
    </button>
  </div>

  <!-- Card Table -->
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-success text-center">
            <tr>
              <th>Nama</th>
              <th>WhatsApp</th>
              <th>Status</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="whatsappTable" class="text-center">
            <tr>
              <td colspan="4" class="text-secondary py-4">
                <div class="spinner-border text-success me-2" role="status"></div>
                Memuat data...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Tambah/Edit -->
<div class="modal fade" id="tambahModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <form id="waForm">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="modalTitle">
            <i class="bi bi-person-plus me-2"></i>Tambah Kontak
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="waId">
          <div class="mb-3">
            <label class="form-label fw-semibold">Nama</label>
            <input type="text" id="waNama" class="form-control" required placeholder="Masukkan nama kontak">
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Nomor WhatsApp</label>
            <input type="text" id="waNomor" class="form-control" required placeholder="628123456789">
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Status</label>
            <input type="text" id="status" class="form-control" placeholder="Contoh: Belum Dikirim">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light border" data-bs-dismiss="modal">
            <i class="bi bi-x-circle text-danger me-1"></i> Batal
          </button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-save me-1"></i> Simpan
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Kirim WA -->
<div class="modal fade" id="kirimModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-whatsapp me-2"></i>Kirim Undangan via WhatsApp
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="kirimNomor">
        <div class="mb-3">
          <label class="form-label fw-semibold">Pesan</label>
          <textarea id="kirimPesan" class="form-control" rows="5" placeholder="Tulis pesan undangan..."></textarea>
        </div>
        <div class="mb-3">
          <label class="form-label fw-semibold">Pilih Template</label>
          <select id="templateSelect" class="form-select">
            <option value="">-- Pilih Template --</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light border" data-bs-dismiss="modal">
          <i class="bi bi-x-circle text-danger me-1"></i> Batal
        </button>
        <button class="btn btn-success" id="btnKirimWA">
          <i class="bi bi-send-fill me-1"></i> Kirim WA
        </button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getDatabase, ref, push, set, onValue, remove, update
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // ==== KONFIGURASI FIREBASE ====
  const firebaseConfig = {
    apiKey: "AIzaSyBNM0mRlVcg7NaKoLbKpXchkM9FbLT09h8",
    authDomain: "mdt-alihkwan.firebaseapp.com",
    databaseURL: "https://mdt-alihkwan-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mdt-alihkwan",
    storageBucket: "mdt-alihkwan.firebasestorage.app",
    messagingSenderId: "984999928991",
    appId: "1:984999928991:web:de038c926a8341e794eeaa"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const waRef = ref(db, "whatsapp");

  // ==== TEMPLATE WHATSAPP ====
const templateWa = [
  {
    nama: "Undangan Umum",
    isi: (data) => {
      const encodedName = encodeURIComponent(data.nama || "");
      return `Assalamu’alaikum Warahmatullahi Wabarakatuh 🙏

Halo ${data.nama}!  
Kami dengan senang hati mengundang Bapak/Ibu/Saudara/i untuk hadir dalam acara:

🎓 Haflah Akhirussanah & Wisuda Santri MDT AL-IKHWAN ke-VII

Acara ini menjadi momen syukur atas perjuangan para santri.  
Besar harapan kami, ${data.nama} berkenan hadir untuk memberikan doa dan dukungan.

📅 Tanggal: Ahad, 20 Oktober 2025  
📍 Tempat: Aula MDT AL-IKHWAN  

Buka undangan lengkapnya di link berikut ya 👇  
🔗 https://mdt-alikhwann.github.io/undangan-haflah/?nama=${encodedName}

Wassalamu’alaikum Warahmatullahi Wabarakatuh 🌿`;
    }
  },
  {
    nama: "Undangan Khusus (Formal)",
    isi: (data) => {
      const encodedName = encodeURIComponent(data.nama || "");
      return `Assalamu’alaikum Warahmatullahi Wabarakatuh.

Kepada Yth.  
Bapak/Ibu/Saudara/i ${data.nama}

Dengan hormat, kami bermaksud mengundang Bapak/Ibu untuk menghadiri acara:

🎓 Haflah Akhirussanah & Wisuda Santri MDT AL-IKHWAN ke-VII  
Sebagai bentuk rasa syukur dan penghargaan atas perjalanan pendidikan santri kami.

🗓️ Hari/Tanggal: Ahad, 20 Oktober 2025  
🕓 Waktu: 07.30 WIB s.d. selesai  
📍 Tempat: Aula MDT AL-IKHWAN  

Buka undangan resmi kami melalui tautan berikut:  
🔗 https://mdt-alikhwann.github.io/undangan-haflah/?nama=${encodedName}  

Atas kehadiran dan doa restunya kami ucapkan terima kasih.  
Wassalamu’alaikum Warahmatullahi Wabarakatuh.`;
    }
  },
  {
    nama: "Undangan Simpel",
    isi: (data) => {
      const encodedName = encodeURIComponent(data.nama || "");
      return `Assalamu’alaikum ${data.nama} 👋

Kami mengundang untuk hadir di acara  
🎓 Haflah Akhirussanah & Wisuda Santri MDT AL-IKHWAN ke-VII  

📅 Ahad, 20 Oktober 2025  
📍 Aula MDT AL-IKHWAN  

Buka undangan lengkap di sini 👇  
🔗 https://mdt-alikhwann.github.io/undangan-haflah/?nama=${encodedName}

Terima kasih atas doa & kehadirannya 🙏`;
    }
  }
];

  // ==== ELEMENT DOM ====
  const waForm = document.getElementById("waForm");
  const waId = document.getElementById("waId");
  const waNama = document.getElementById("waNama");
  const waNomor = document.getElementById("waNomor");
  const status = document.getElementById("status");
  const waTable = document.getElementById("whatsappTable");
  const modalTitle = document.getElementById("modalTitle");
  const modal = new bootstrap.Modal(document.getElementById("tambahModal"));

  const kirimModalEl = document.getElementById("kirimModal");
  const kirimModal = new bootstrap.Modal(kirimModalEl);
  const kirimNomor = document.getElementById("kirimNomor");
  const kirimPesan = document.getElementById("kirimPesan");
  const templateSelect = document.getElementById("templateSelect");
  const btnKirimWA = document.getElementById("btnKirimWA");

  let currentRecipient = null;

  // ==== FORMAT NOMOR WA ====
  function formatNomorWA(inputNomor) {
    if (!inputNomor) return "";
    let nomor = inputNomor.replace(/\D/g, "");

    if (nomor.startsWith("0")) {
      nomor = "62" + nomor.slice(1);
    } else if (nomor.startsWith("8")) {
      nomor = "62" + nomor;
    } else if (nomor.startsWith("+62")) {
      nomor = nomor.replace("+", "");
    }

    return nomor;
  }

  // ==== RENDER DATA TABEL ====
  onValue(waRef, (snapshot) => {
    waTable.innerHTML = "";
    if (!snapshot.exists()) {
      waTable.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Belum ada data</td></tr>`;
      return;
    }

    const dataList = [];
snapshot.forEach((child) => {
  dataList.push({ key: child.key, ...child.val() });
});
dataList.reverse();
dataList.forEach((data) => {
  const key = data.key;

      const tr = document.createElement("tr");
      tr.id = `row-${key}`;

      const tdNama = document.createElement("td");
      tdNama.textContent = data.nama || "";
      //tdNama.classList.add("text-capitalize", "text-start");
      tdNama.className = "text-capitalize text-start";

      const tdNomor = document.createElement("td");
      tdNomor.textContent = data.nomor || "";

      const tdStatus = document.createElement("td");
      tdStatus.innerHTML = data.status === "Terkirim" ? `<i class="bi bi-check-circle-fill text-success"></i>` : `<i class="bi bi-x-circle-fill text-danger"></i> `;

      const tdAksi = document.createElement("td");

      // bungkus tombol dalam flex container agar ada gap
const btnGroup = document.createElement("div");
btnGroup.className = "d-flex gap-2 justify-content-center";

      // Tombol kirim WA
      const btnKirim = document.createElement("button");
      btnKirim.type = "button";
      btnKirim.className = "btn btn-sm btn-success";
      btnKirim.title = "Kirim WA";
      btnKirim.innerHTML = `<i class="bi bi-whatsapp"></i>`;
      btnKirim.addEventListener("click", () => kirimWA({ key, ...data }));

      // Tombol edit
      const btnEdit = document.createElement("button");
      btnEdit.type = "button";
      btnEdit.className = "btn btn-sm btn-warning";
      btnEdit.title = "Edit";
      btnEdit.innerHTML = `<i class="bi bi-pencil"></i>`;
      btnEdit.addEventListener("click", () => {
        waId.value = key;
        waNama.value = data.nama || "";
        waNomor.value = data.nomor || "";
        status.value = data.status || "";
        modalTitle.textContent = "Edit Kontak";
        modal.show();
      });

      // Tombol hapus
      const btnHapus = document.createElement("button");
      btnHapus.type = "button";
      btnHapus.className = "btn btn-sm btn-danger";
      btnHapus.title = "Hapus";
      btnHapus.innerHTML = `<i class="bi bi-trash"></i>`;
      btnHapus.addEventListener("click", async () => {
        if (confirm("Yakin ingin menghapus kontak ini?")) {
          await remove(ref(db, "whatsapp/" + key));
        }
      });

      // Jika sudah terkirim
      if (data.status === "Terkirim") {
        btnKirim.disabled = true;
        btnKirim.innerHTML = `<i class="bi bi-check-circle-fill"></i>`;
        btnKirim.title = "Sudah dikirim";
      }

      btnGroup.append(btnKirim, btnEdit, btnHapus);
      tdAksi.appendChild(btnGroup);
      tr.append(tdNama, tdNomor, tdStatus, tdAksi);
      waTable.appendChild(tr);
    });
  });

  // ==== TAMBAH / EDIT KONTAK ====
  waForm.onsubmit = async (e) => {
    e.preventDefault();
    let nama = waNama.value.trim();
    const nomorRaw = waNomor.value.trim();
    const nomor = formatNomorWA(nomorRaw);
    const stat = status.value.trim() || "Belum kirim";

    // Auto text-capitalize setiap awal kata
    nama = nama.replace(/\b\w/g, (c) => c.toUpperCase());

    if (!nama || !nomor) {
      alert("Nama dan nomor harus diisi!");
      return;
    }

    if (waId.value) {
      await update(ref(db, "whatsapp/" + waId.value), { nama, nomor, status:stat });
    } else {
      const newRef = push(waRef);
      await set(newRef, { nama, nomor, status: stat });
    }

    waForm.reset();
    waId.value = "";
    modal.hide();
  };

  // ==== FUNGSI KIRIM WA ====
  function kirimWA(recipient) {
    currentRecipient = recipient;
    kirimNomor.value = recipient.nomor || "";
    kirimPesan.value = "";
    loadTemplatesFor(recipient);
    kirimModal.show();
  }

  // ==== LOAD TEMPLATE ====
  function loadTemplatesFor(recipient) {
    templateSelect.innerHTML = `<option value="">-- Pilih Template --</option>`;
    templateWa.forEach((t, idx) => {
      const opt = document.createElement("option");
      opt.value = idx;
      opt.textContent = t.nama;
      templateSelect.appendChild(opt);
    });
    kirimPesan.value = "";
  }

  // ==== PILIH TEMPLATE ====
  templateSelect.addEventListener("change", () => {
    const val = templateSelect.value;
    if (val === "") {
      kirimPesan.value = "";
      return;
    }
    const idx = parseInt(val);
    const tpl = templateWa[idx];
    if (tpl) kirimPesan.value = tpl.isi(currentRecipient);
  });

  // ==== KIRIM WA ====
  btnKirimWA.addEventListener("click", async () => {
    const nomorInput = kirimNomor.value.trim();
    let pesan = kirimPesan.value.trim();

    if (!nomorInput) {
      alert("Nomor penerima kosong.");
      return;
    }
    if (!pesan) {
      alert("Pesan tidak boleh kosong!");
      return;
    }

    const nomorFinal = formatNomorWA(nomorInput);
    if (!nomorFinal) {
      alert("Nomor tidak valid.");
      return;
    }

    const encodedMsg = encodeURIComponent(pesan);
    window.open(`https://wa.me/${nomorFinal}?text=${encodedMsg}`, "_blank");

    // === ✅ Tandai status terkirim di Firebase ===
    if (currentRecipient?.key) {
      await update(ref(db, "whatsapp/" + currentRecipient.key), { status: "Terkirim" });

      const row = document.getElementById(`row-${currentRecipient.key}`);
      if (row) {
        
        const btn = row.querySelector(".btn-success");
        if (btn) {
          btn.disabled = true;
          
        }
        
      }
    }

    kirimModal.hide();
  });

  // ==== RESET MODAL ====
  kirimModalEl.addEventListener("hidden.bs.modal", () => {
    currentRecipient = null;
    templateSelect.innerHTML = `<option value="">-- Pilih Template --</option>`;
    kirimPesan.value = "";
    kirimNomor.value = "";
  });
</script>


</body>
</html>
