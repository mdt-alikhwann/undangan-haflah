<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buku Tamu Digital</title>

  <!-- ‚úÖ Bootstrap 5.3 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"/>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onValue,
      query,
      limitToLast,
      get,
      remove,
      child,
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";

    // üî• Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBNM0mRlVcg7NaKoLbKpXchkM9FbLT09h8",
      authDomain: "mdt-alihkwan.firebaseapp.com",
      databaseURL:
        "https://mdt-alihkwan-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "mdt-alihkwan",
      storageBucket: "mdt-alihkwan.firebasestorage.app",
      messagingSenderId: "984999928991",
      appId: "1:984999928991:web:de038c926a8341e794eeaa",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const attendanceRef = ref(db, "attendance");

    // === SIMPAN DATA ABSENSI ===
    async function saveAttendance(name) {
      const msg = document.getElementById("scan-message");
      const nama = name.trim().toLowerCase();
      if (!nama) return;

      // üîç Cek apakah nama sudah pernah hadir
      const snapshot = await get(attendanceRef);
      let sudahAda = false;

      if (snapshot.exists()) {
        const data = snapshot.val();
        for (const id in data) {
          if (data[id].nama.toLowerCase() === nama) {
            sudahAda = true;
            break;
          }
        }
      }

      if (sudahAda) {
        msg.innerHTML = `<div class="alert alert-warning mt-3">
          ‚ö†Ô∏è <strong>${name}</strong> sudah hadir!
        </div>`;
        return;
      }

      // Simpan data baru
      const now = new Date();
      const tanggal = now.toLocaleDateString("id-ID", {
        weekday: "long",
        day: "numeric",
        month: "long",
        year: "numeric",
      });
      const waktu = now.toLocaleTimeString("id-ID", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });

      await push(attendanceRef, {
        nama: name,
        tanggal,
        waktu,
        timestamp: now.toISOString(),
      });

      msg.innerHTML = `<div class="alert alert-success mt-3">
        ‚úÖ <strong>${name}</strong> tercatat hadir pada <strong>${tanggal}</strong> ${waktu}
      </div>`;
    }

    // === HAPUS DATA ===
    async function deleteEntry(id, nama) {
      if (confirm(`Yakin mau hapus data "${nama}"?`)) {
        await remove(child(attendanceRef, id));
      }
    }
    window.deleteEntry = deleteEntry;

    // === RENDER DATA REALTIME ===
    function renderAttendance(data) {
      const tbody = document.getElementById("attendance-list");
      tbody.innerHTML = "";

      const list = Object.entries(data || {}).sort(
        (a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp)
      );

      for (const [id, item] of list) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.nama}</td>
          <td>${item.tanggal}</td>
          <td>${item.waktu}</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="deleteEntry('${id}','${item.nama}')">
              <i class="bi bi-trash-fill"></i>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    onValue(query(attendanceRef, limitToLast(500)), (snapshot) => {
      if (snapshot.exists()) {
        renderAttendance(snapshot.val());
      } else {
        document.getElementById("attendance-list").innerHTML = `
          <tr><td colspan="4" class="text-center text-muted">Belum ada data.</td></tr>`;
      }
    });

    // === INPUT MANUAL ===
    window.manualInput = () => {
      const name = document.getElementById("manual-name").value.trim();
      if (name) saveAttendance(name);
      document.getElementById("manual-name").value = "";
    };

    // === INISIASI QR SCANNER ===
    window.onload = function () {
      const video = document.getElementById("preview");
      const script = document.createElement("script");
      script.src =
        "https://rawcdn.githack.com/schmich/instascan-builds/master/instascan.min.js";
      script.onload = () => {
        const scanner = new Instascan.Scanner({ video: video });
        scanner.addListener("scan", function (content) {
          saveAttendance(content.trim());
        });

        // üîπ Gunakan kamera belakang (jika ada)
        Instascan.Camera.getCameras().then((cameras) => {
          if (cameras.length > 1) {
            scanner.start(cameras[cameras.length - 1]);
          } else if (cameras.length > 0) {
            scanner.start(cameras[0]);
          } else {
            alert("Kamera tidak ditemukan!");
          }
        });
      };
      document.body.appendChild(script);
    };
  </script>

  <style>
    body {
      background-color: #f8fafc;
    }
    video {
      width: 100%;
      max-width: 400px;
      border-radius: 12px;
      border: 2px solid #dee2e6;
      max-height: 350px;
    }
    .table th {
      background-color: #f1f3f5;
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <div class="text-center mb-4">
      <h1 class="fw-bold"><i class="bi bi-journal-bookmark-fill"></i> Buku Tamu</h1>
      <p class="text-muted mb-0">Haflah Akhirussanah dan Wisuda MDT AL-IKHWAN</p>
    </div>

    <div class="row justify-content-center mb-4">
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <h5 class="card-title mb-3"><i class="bi bi-camera-fill"></i> Kamera Scan QR</h5>
            <video id="preview" class="mb-3"></video>

            <h6>Masukkan Nama Manual</h6>
            <div class="input-group mb-3">
              <input
                type="text"
                id="manual-name"
                class="form-control"
                placeholder="Contoh: Hisyam Aziz"
              />
              <button class="btn btn-primary" onclick="manualInput()">Kirim</button>
            </div>

            <div id="scan-message"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3"><i class="bi bi-person-vcard"></i> Daftar Hadir (Realtime)</h5>
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead>
              <tr>
                <th>Nama</th>
                <th>Tanggal</th>
                <th>Waktu</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="attendance-list">
              <tr>
                <td colspan="4" class="text-center text-muted">
                  Memuat data...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 
